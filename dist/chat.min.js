/**
 * Beautiful Flowise Chat Widget v2.0.8
 * FIXED: Duplicate messages & restore after refresh
 * Full-Width AI Messages (95% bot, 65% user)
 * Production minified build
 */
!function(){"use strict";const e={theme:"modern",primaryColor:"#6366f1",primaryDarkColor:null,position:"bottom-right",width:"400px",height:"600px",title:"AI Assistant",subtitle:"Online",welcomeMessage:"Hi! How can I help you today?",placeholder:"Type your message...",sendButtonText:"âž¤",showTimestamp:!0,enableStreaming:!0,enableMarkdown:!0,clearChatOnReload:!1,confirmOnReset:!0,maxMessages:100,requestTimeout:3e4,debug:!1,avatar:"ðŸ¤–",mode:"popup",customUserMessageBg:null,customUserMessageText:null,customChatBg:null},t={FOCUS_DELAY:100,SCROLL_THROTTLE:100,STREAM_UPDATE_INTERVAL:50,STREAM_MIN_CHARS:3,MAX_INPUT_HEIGHT:120,MIN_REQUEST_INTERVAL:500,ALLOWED_URL_SCHEMES:["http:","https:","mailto:","tel:"],BOLD_PLACEHOLDER_START:"{{BFBOLDSTART}}",BOLD_PLACEHOLDER_END:"{{BFBOLDEND}}",CODE_BLOCK_PLACEHOLDER:"{{BFCODEBLOCK_",INLINE_CODE_PLACEHOLDER:"{{BFINLINECODE_"};class s{constructor(t){this.config={...e,...t},this.chatflowid=t.chatflowid,this.apiHost=t.apiHost,this.storageKey=`${this.chatflowid}_INTERNAL`,this.isOpen="fullscreen"===this.config.mode,this.currentStreamingMessageId=null,this.messages=[],this.chatId=null,this.lastScrollTime=0,this.scrollPending=!1,this.scrollAnimationFrame=null,this.streamBuffer="",this.streamLastUpdate="",this.streamUpdateTimer=null,this.streamCharCount=0,this.firstTokenReceived=!1,this.abortController=null,this.isSending=!1,this.lastRequestTime=0,this.eventListeners=[],this.welcomeAdded=!1,this.init()}init(){const e=document.getElementById("beautiful-flowise-container");e&&(this.log("Removing existing widget instance"),e.remove()),this.injectStyles(),this.createWidget(),this.applyCustomThemeColors(),this.attachEventListeners(),this.loadFromStorage(),this.log("Chat ID:",this.chatId||"Not yet assigned"),this.log("Mode:",this.config.mode),this.log("Messages loaded:",this.messages.length)}applyCustomThemeColors(){const e=document.getElementById("beautiful-flowise-container");if(!e)return;e.style.setProperty("--bf-primary-color",this.config.primaryColor);const t=this.config.primaryDarkColor||this.darkenColor(this.config.primaryColor);if(e.style.setProperty("--bf-primary-dark",t),"custom"===this.config.theme){if(this.config.customUserMessageBg)e.style.setProperty("--bf-custom-user-msg-bg",this.config.customUserMessageBg);else{const t=this.colorToRgba(this.config.primaryColor,.15);e.style.setProperty("--bf-custom-user-msg-bg",t)}this.config.customUserMessageText&&e.style.setProperty("--bf-custom-user-msg-text",this.config.customUserMessageText),this.config.customChatBg&&e.style.setProperty("--bf-custom-chat-bg",this.config.customChatBg)}}darkenColor(e){if(!e)return"#4f46e5";if(e.startsWith("#"))return this.darkenHex(e);const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(t){const[,e,s,a,n]=t,i=Math.max(0,Math.floor(.8*parseInt(e))),r=Math.max(0,Math.floor(.8*parseInt(s))),o=Math.max(0,Math.floor(.8*parseInt(a)));return void 0!==n?`rgba(${i}, ${r}, ${o}, ${n})`:`rgb(${i}, ${r}, ${o})`}return"#4f46e5"}darkenHex(e){if(e=e.replace("#",""),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),6!==e.length)return"#4f46e5";const t=Math.max(0,Math.floor(.8*parseInt(e.substring(0,2),16))),s=Math.max(0,Math.floor(.8*parseInt(e.substring(2,4),16))),a=Math.max(0,Math.floor(.8*parseInt(e.substring(4,6),16)));return`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`}colorToRgba(e,t){if(!e)return`rgba(99, 102, 241, ${t})`;const s=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(s){const[,e,a,n]=s;return`rgba(${e}, ${a}, ${n}, ${t})`}if(e.startsWith("#")){let s=e.replace("#","");if(3===s.length&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]),6===s.length){const e=parseInt(s.substring(0,2),16),a=parseInt(s.substring(2,4),16),n=parseInt(s.substring(4,6),16);if(!isNaN(e)&&!isNaN(a)&&!isNaN(n))return`rgba(${e}, ${a}, ${n}, ${t})`}}return`rgba(99, 102, 241, ${t})`}log(...e){this.config.debug&&console.log("[BeautifulFlowise]",...e)}loadFromStorage(){if(this.config.clearChatOnReload)return this.messages=[],this.chatId=null,void this.initializeWithWelcome();try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);if("object"!=typeof t||null===t)throw new Error("Invalid data structure");if(t.chatId?/^[a-f0-9-]{36}$/i.test(t.chatId)?(this.chatId=t.chatId,this.log("Loaded chatId from storage:",this.chatId)):(this.log("Invalid chatId format, clearing"),t.chatId=null):t.messages&&Array.isArray(t.messages)){if(t.messages.length>this.config.maxMessages&&(this.log(`Trimming message history from ${t.messages.length} to ${this.config.maxMessages}`),t.messages=t.messages.slice(-this.config.maxMessages)),t.messages.length>0)return this.messages=t.messages,this.welcomeAdded=!0,void this.restoreMessages();this.initializeWithWelcome()}else this.initializeWithWelcome()}else this.initializeWithWelcome()}catch(e){this.log("Error loading from storage:",e),localStorage.removeItem(this.storageKey),this.initializeWithWelcome()}}initializeWithWelcome(){if(this.welcomeAdded)return;this.messages=[],this.config.welcomeMessage&&(this.messages.push({role:"bot",content:this.config.welcomeMessage}),this.addMessageToUI(this.config.welcomeMessage,"bot"),this.welcomeAdded=!0,this.saveToStorage())}saveToStorage(){if(this.config.clearChatOnReload)return;try{let e=this.messages;e.length>this.config.maxMessages&&(e=e.slice(-this.config.maxMessages),this.messages=e);const t={chatId:this.chatId,messages:e};localStorage.setItem(this.storageKey,JSON.stringify(t)),this.log("Saved to storage - chatId:",this.chatId,"messages:",e.length)}catch(e){this.log("Error saving to storage:",e)}}restoreMessages(){const e=document.getElementById("bf-messages");e.innerHTML="",this.messages.forEach((e=>{this.addMessageToUI(e.content,e.role)})),this.scrollToBottom(),this.log("Restored",this.messages.length,"messages")}resetConversation(){if((this.config.confirmOnReset?confirm("Are you sure you want to clear the chat history?"):1)&&(this.abortController&&(this.abortController.abort(),this.abortController=null),localStorage.removeItem(this.storageKey),this.chatId=null,this.messages=[],this.isSending=!1,this.currentStreamingMessageId=null,this.welcomeAdded=!1,document.getElementById("bf-messages").innerHTML="",document.getElementById("bf-input"))){const e=document.getElementById("bf-send");document.getElementById("bf-input").disabled=!1,e&&(e.disabled=!1)}this.initializeWithWelcome(),this.log("Chat reset")}injectStyles(){if(!document.getElementById("beautiful-flowise-styles")){const e=document.createElement("style");e.id="beautiful-flowise-styles",e.textContent=':root{--bf-primary-color:#6366f1;--bf-primary-dark:#4f46e5;--bf-custom-user-msg-bg:rgba(99,102,241,.15);--bf-custom-user-msg-text:#1f2937;--bf-custom-chat-bg:#fff}.bf-container *{box-sizing:border-box;margin:0;padding:0}.bf-container{position:fixed;z-index:999999;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}.bf-mode-popup{bottom:20px;right:20px}.bf-mode-popup.bf-bottom-left{bottom:20px;left:20px;right:auto}.bf-mode-fullscreen{top:0;left:0;width:100vw;height:100vh;bottom:auto;right:auto}.bf-chat-button{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--bf-primary-color),var(--bf-primary-dark));border:none;cursor:pointer;box-shadow:0 10px 40px rgba(0,0,0,.15);transition:transform .3s;display:flex;align-items:center;justify-content:center}.bf-mode-fullscreen .bf-chat-button{display:none!important}.bf-chat-button:hover{transform:scale(1.1)}.bf-button-icon{width:28px;height:28px;color:#fff;stroke-width:2}.bf-chat-window{position:absolute;background:#fff;display:flex;flex-direction:column;overflow:hidden;animation:slideUp .3s ease}.bf-mode-popup .bf-chat-window{bottom:80px;right:0;width:400px;max-width:calc(100vw - 40px);height:600px;max-height:calc(100vh - 120px);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15)}.bf-mode-popup.bf-bottom-left .bf-chat-window{left:0;right:auto}.bf-mode-fullscreen .bf-chat-window{position:fixed;top:0;left:0;bottom:0;right:0;width:100vw;height:100vh;border-radius:0;box-shadow:none;display:flex!important;animation:none}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.bf-header{background:linear-gradient(135deg,var(--bf-primary-color),var(--bf-primary-dark));color:#fff;padding:20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.bf-header-content{display:flex;align-items:center;gap:12px;flex:1}.bf-avatar{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:20px}.bf-title{font-size:16px;font-weight:600}.bf-subtitle{font-size:12px;opacity:.9}.bf-header-actions{display:flex;gap:8px;align-items:center}.bf-reset-btn{background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background .2s}.bf-reset-btn:hover{background:rgba(255,255,255,.3)}.bf-minimize-btn{background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center}.bf-mode-fullscreen .bf-minimize-btn{display:none}.bf-messages{flex:1;overflow-y:auto;padding:20px;background:#f9fafb;display:flex;flex-direction:column;gap:16px}.bf-messages::-webkit-scrollbar{width:6px}.bf-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}.bf-message{display:flex!important;animation:fadeIn .3s;width:100%!important;padding:0!important;margin:0!important}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.bf-message.bf-bot-message{justify-content:flex-start!important}.bf-message.bf-user-message{justify-content:flex-end!important}.bf-message-content{display:flex!important;flex-direction:column!important;margin:0!important;padding:0!important}.bf-bot-message .bf-message-content{align-items:flex-start!important;max-width:95%!important}.bf-user-message .bf-message-content{align-items:flex-end!important;max-width:65%!important}.bf-message-text{padding:12px 16px!important;border-radius:16px;font-size:14px;line-height:1.6;word-wrap:break-word;overflow-wrap:break-word;word-break:keep-all;hyphens:none;white-space:pre-wrap;display:inline-block!important;width:fit-content!important;max-width:100%!important;text-align:left!important;margin:0!important}.bf-bot-message .bf-message-text{background:#fff;color:#1f2937;box-shadow:0 2px 8px rgba(0,0,0,.08)}.bf-user-message .bf-message-text{background:var(--bf-custom-user-msg-bg)!important;color:var(--bf-custom-user-msg-text)!important;border:none!important;box-shadow:none!important}.bf-message-time{font-size:11px;color:#6b7280;margin-top:4px;padding:0 4px}.bf-bot-message .bf-message-text p{margin:0 0 10px}.bf-bot-message .bf-message-text p:last-child{margin-bottom:0}.bf-bot-message .bf-message-text strong{font-weight:600;color:#111827}.bf-bot-message .bf-message-text em{font-style:italic}.bf-bot-message .bf-message-text code{background:#f3f4f6;padding:3px 7px;border-radius:4px;font-family:"Courier New",monospace;font-size:13px;color:#be123c}.bf-bot-message .bf-message-text pre{background:#1f2937;color:#f9fafb;padding:14px;border-radius:8px;overflow-x:auto;margin:10px 0}.bf-bot-message .bf-message-text pre code{background:0 0;color:#f9fafb;padding:0}.bf-bot-message .bf-message-text ol,.bf-bot-message .bf-message-text ul{margin:10px 0;padding-left:24px}.bf-bot-message .bf-message-text li{margin:6px 0;line-height:1.5}.bf-bot-message .bf-message-text a{color:var(--bf-primary-color);text-decoration:underline}.bf-bot-message .bf-message-text h1,.bf-bot-message .bf-message-text h2,.bf-bot-message .bf-message-text h3{font-weight:600;color:#111827;margin:14px 0 8px;line-height:1.3}.bf-bot-message .bf-message-text h1{font-size:18px}.bf-bot-message .bf-message-text h2{font-size:16px}.bf-bot-message .bf-message-text h3{font-size:15px}.bf-loading-dots{display:flex;align-items:center;gap:4px}.bf-loading-dots span{width:8px;height:8px;background:var(--bf-primary-color);border-radius:50%;animation:pulse-dot 1.4s ease-in-out infinite}.bf-loading-dots span:nth-child(1){animation-delay:0s}.bf-loading-dots span:nth-child(2){animation-delay:.2s}.bf-loading-dots span:nth-child(3){animation-delay:.4s}@keyframes pulse-dot{0%,60%,to{transform:scale(.8);opacity:.5}30%{transform:scale(1.2);opacity:1}}.bf-streaming .bf-message-text{will-change:contents}.bf-streaming .bf-cursor{display:inline-block;width:2px;height:1em;background:var(--bf-primary-color);margin-left:2px;animation:blink-cursor 1s steps(2,start) infinite;vertical-align:text-bottom}@keyframes blink-cursor{50%{opacity:0}}.bf-input-container{padding:16px;background:#fff;border-top:1px solid #e5e7eb;display:flex;gap:10px;align-items:flex-end;flex-shrink:0}.bf-input{flex:1;border:2px solid #e5e7eb;border-radius:12px;padding:12px 16px;font-size:14px;font-family:inherit;resize:none;outline:0;transition:border-color .2s;max-height:120px;min-height:44px;color:#1f2937}.bf-input:focus{border-color:var(--bf-primary-color)}.bf-input:disabled{opacity:.6;cursor:not-allowed;background:#f3f4f6}.bf-send-btn{background:linear-gradient(135deg,var(--bf-primary-color),var(--bf-primary-dark));color:#fff;border:none;border-radius:12px;width:44px;height:44px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:transform .2s;flex-shrink:0}.bf-send-btn:hover{transform:scale(1.05)}.bf-send-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}.bf-footer{padding:8px;text-align:center;background:#f9fafb;border-top:1px solid #e5e7eb;flex-shrink:0}.bf-branding{font-size:11px;color:#6b7280;text-decoration:none;transition:color .2s}.bf-branding:hover{color:var(--bf-primary-color)}.bf-theme-cloudflare{--bf-primary-color:#f38020;--bf-primary-dark:#d96b0f}.bf-theme-intercom{--bf-primary-color:#1f8ded;--bf-primary-dark:#1273c5}.bf-theme-gradient{--bf-primary-color:#667eea;--bf-primary-dark:#764ba2}.bf-theme-glassmorphism .bf-chat-window{background:rgba(255,255,255,.7);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.3)}.bf-theme-glassmorphism .bf-user-message .bf-message-text{backdrop-filter:blur(10px)}.bf-theme-dark{--bf-primary-color:#6366f1;--bf-primary-dark:#4f46e5;--bf-custom-user-msg-text:#e0e7ff}.bf-theme-dark .bf-chat-window{background:#1f2937}.bf-theme-dark .bf-messages{background:#111827}.bf-theme-dark .bf-bot-message .bf-message-text{background:#374151!important;color:#f9fafb!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}.bf-theme-dark .bf-user-message .bf-message-text{background:rgba(99,102,241,.25)!important}.bf-theme-dark .bf-input{background:#374151;color:#f9fafb;border-color:#4b5563}.bf-theme-dark .bf-input::placeholder{color:#9ca3af}.bf-theme-dark .bf-footer,.bf-theme-dark .bf-input-container{background:#1f2937;border-top-color:#374151}.bf-theme-dark .bf-branding,.bf-theme-dark .bf-message-time{color:#9ca3af}.bf-theme-minimal{--bf-primary-color:#000;--bf-primary-dark:#1f2937;--bf-custom-user-msg-bg:rgba(0,0,0,.06)}.bf-theme-custom .bf-chat-button,.bf-theme-custom .bf-header,.bf-theme-custom .bf-send-btn{background:linear-gradient(135deg,var(--bf-primary-color),var(--bf-primary-dark))!important}.bf-theme-custom .bf-chat-window,.bf-theme-custom .bf-footer,.bf-theme-custom .bf-input-container,.bf-theme-custom .bf-messages{background:var(--bf-custom-chat-bg)!important}.bf-theme-custom .bf-loading-dots span,.bf-theme-custom .bf-streaming .bf-cursor{background:var(--bf-primary-color)!important}.bf-theme-custom .bf-input:focus{border-color:var(--bf-primary-color)!important}.bf-theme-custom .bf-bot-message .bf-message-text a,.bf-theme-custom .bf-branding:hover{color:var(--bf-primary-color)!important}',document.head.appendChild(e)}}createWidget(){const e=document.createElement("div");e.id="beautiful-flowise-container",e.className=`bf-container bf-mode-${this.config.mode} bf-${this.config.position} bf-theme-${this.config.theme}`;const t="fullscreen"===this.config.mode?"flex":"none";e.innerHTML=`
                <button class="bf-chat-button" id="bf-toggle-button">
                    <svg class="bf-button-icon bf-button-open" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <svg class="bf-button-icon bf-button-close" style="display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div class="bf-chat-window" id="bf-chat-window" style="display: ${t};">
                    <div class="bf-header">
                        <div class="bf-header-content">
                            <div class="bf-avatar">${this.config.avatar}</div>
                            <div class="bf-header-text">
                                <div class="bf-title">${this.config.title}</div>
                                <div class="bf-subtitle">${this.config.subtitle}</div>
                            </div>
                        </div>
                        <div class="bf-header-actions">
                            <button class="bf-reset-btn" id="bf-reset" title="Reset Chat">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="1 4 1 10 7 10"></polyline>
                                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                </svg>
                            </button>
                            <button class="bf-minimize-btn" id="bf-minimize">âˆ’</button>
                        </div>
                    </div>
                    <div class="bf-messages" id="bf-messages"></div>
                    <div class="bf-input-container">
                        <textarea class="bf-input" id="bf-input" placeholder="${this.config.placeholder}" rows="1"></textarea>
                        <button class="bf-send-btn" id="bf-send">${this.config.sendButtonText}</button>
                    </div>
                    <div class="bf-footer">
                        <a href="mailto:mail.rps.active@proton.me" class="bf-branding">Powered by RPS</a>
                    </div>
                </div>
            `,document.body.appendChild(e)}attachEventListeners(){const e=(e,t,s)=>{e&&(e.addEventListener(t,s),this.eventListeners.push({element:e,event:t,handler:s}))};e(document.getElementById("bf-toggle-button"),"click",(()=>this.toggleChat()));const s=document.getElementById("bf-minimize");s&&"popup"===this.config.mode&&e(s,"click",(()=>this.toggleChat())),e(document.getElementById("bf-reset"),"click",(()=>this.resetConversation())),e(document.getElementById("bf-send"),"click",(()=>this.sendMessage()));const a=document.getElementById("bf-input");e(a,"keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),e(a,"input",(()=>{a.style.height="auto",a.style.height=Math.min(a.scrollHeight,t.MAX_INPUT_HEIGHT)+"px"})),"fullscreen"===this.config.mode&&setTimeout((()=>a.focus()),t.FOCUS_DELAY)}removeEventListeners(){this.eventListeners.forEach((({element:e,event:t,handler:s})=>{e&&e.removeEventListener(t,s)})),this.eventListeners=[]}toggleChat(){if("fullscreen"===this.config.mode)return;this.isOpen=!this.isOpen;const e=document.getElementById("bf-chat-window"),t=document.querySelector(".bf-button-open"),s=document.querySelector(".bf-button-close");this.isOpen?(e.style.display="flex",t.style.display="none",s.style.display="block",document.getElementById("bf-input").focus()):(e.style.display="none",t.style.display="block",s.style.display="none",this.abortController&&(this.abortController.abort(),this.abortController=null))}async sendMessage(){const e=document.getElementById("bf-input"),s=document.getElementById("bf-send"),a=e.value.trim();if(a&&!this.isSending){const n=Date.now();if(n-this.lastRequestTime<t.MIN_REQUEST_INTERVAL)return void this.log("Rate limited");this.lastRequestTime=n,this.isSending=!0,e.disabled=!0,s.disabled=!0,this.addMessage(a,"user"),e.value="",e.style.height="auto";const i=this.createPlaceholderMessage();this.currentStreamingMessageId=i,this.firstTokenReceived=!1,this.abortController=new AbortController;try{this.config.enableStreaming?await this.sendWithStreaming(a,i):await this.sendWithoutStreaming(a,i)}catch(e){"AbortError"===e.name?this.log("Request aborted"):(this.log("Error:",e),document.getElementById(i)?.remove(),this.addMessage("I'm having trouble connecting. Please try again. ðŸ”„","bot"))}finally{this.currentStreamingMessageId=null,this.abortController=null,this.isSending=!1,e.disabled=!1,s.disabled=!1}}}async fetchWithTimeout(e,t){const s=this.abortController,a=setTimeout((()=>{s&&s.abort()}),this.config.requestTimeout);try{const n=await fetch(e,{...t,signal:s?s.signal:void 0});return clearTimeout(a),n}catch(e){if(clearTimeout(a),"AbortError"===e.name)throw new Error("Request timeout or aborted");throw e}}async sendWithStreaming(e,s){try{const a={question:e,streaming:!0};this.chatId&&(a.chatId=this.chatId);const n=await this.fetchWithTimeout(`${this.apiHost}/api/v1/prediction/${this.chatflowid}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw new Error("API failed");if(!n.headers.get("content-type")?.includes("text/event-stream")){const e=await n.json();return e.chatId&&e.chatId!==this.chatId&&(this.chatId=e.chatId,this.saveToStorage(),this.log("ChatId assigned:",this.chatId)),this.updatePlaceholderMessage(s,e.text||e.answer||e.response||"No response",!1),void this.addMessageToStorage(e.text||e.answer||e.response||"No response","bot")}const i=n.body.getReader(),r=new TextDecoder;let o="";for(this.streamBuffer="",this.streamLastUpdate="",this.streamCharCount=0,this.firstTokenReceived=!1;;){const{value:e,done:a}=await i.read();if(a)break;o+=r.decode(e,{stream:!0});const n=o.split("\n");for(const e of(o=n.pop()||"",n)){const a=e.trim();if(a&&!a.startsWith(":")&&a.startsWith("data:")){const e=a.slice(5).trim();if("[DONE]"===e||'"[DONE]"'===e)continue;let a="",n=null;try{const t=JSON.parse(e);t&&"object"==typeof t&&("token"===t.event&&t.data?a=t.data:"metadata"===t.event&&t.data?n=t.data:"string"==typeof t&&(a=t))}catch{e.startsWith('"')&&e.endsWith('"')?a=e.startsWith('"')&&e.endsWith('"')?JSON.parse(e):e.slice(1,-1):a=e}n&&n.chatId&&n.chatId!==this.chatId&&(this.chatId=n.chatId,this.saveToStorage(),this.log("ChatId assigned:",this.chatId)),a&&(this.streamBuffer+=a,this.streamCharCount++,(()=>{if(this.streamUpdateTimer)return;this.streamUpdateTimer=setTimeout((()=>{(this.streamBuffer.length-this.streamLastUpdate.length>=t.STREAM_MIN_CHARS||!this.firstTokenReceived)&&(this.updatePlaceholderMessage(s,this.streamBuffer,!0),this.streamLastUpdate=this.streamBuffer,this.firstTokenReceived=!0),this.streamUpdateTimer=null}),t.STREAM_UPDATE_INTERVAL)})())}}}if(this.streamUpdateTimer&&(clearTimeout(this.streamUpdateTimer),this.streamUpdateTimer=null),!this.streamBuffer)throw new Error("No text streamed");this.updatePlaceholderMessage(s,this.streamBuffer,!1),this.addMessageToStorage(this.streamBuffer,"bot"),this.streamBuffer=""}catch(t){if("AbortError"===t.name||t.message.includes("aborted"))throw t;this.log("Streaming failed:",t),await this.sendWithoutStreaming(e,s)}}async sendWithoutStreaming(e,t){const s={question:e};this.chatId&&(s.chatId=this.chatId);const a=await this.fetchWithTimeout(`${this.apiHost}/api/v1/prediction/${this.chatflowid}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error("API failed");const n=await a.json();n.chatId&&n.chatId!==this.chatId&&(this.chatId=n.chatId,this.saveToStorage(),this.log("ChatId assigned:",this.chatId));const i=n.text||n.answer||n.response||"No response";this.updatePlaceholderMessage(t,i,!1),this.addMessageToStorage(i,"bot")}addMessageToStorage(e,t){this.messages.push({role:t,content:e}),this.saveToStorage()}addMessage(e,t){this.addMessageToStorage(e,t),this.addMessageToUI(e,t)}addMessageToUI(e,t){const s=document.getElementById("bf-messages"),a=document.createElement("div");a.className=`bf-message bf-${t}-message`;const n="bot"===t?this.formatMarkdown(e):this.escapeHtml(e);a.innerHTML=`
                <div class="bf-message-content">
                    <div class="bf-message-text">${n}</div>
                    ${this.config.showTimestamp?`<div class="bf-message-time">${this.getTimeString()}</div>`:""}
                </div>
            `,s.appendChild(a),this.scrollToBottom()}createPlaceholderMessage(){const e=document.getElementById("bf-messages"),t="msg-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),s=document.createElement("div");return s.id=t,s.className="bf-message bf-bot-message",s.innerHTML=`
                <div class="bf-message-content">
                    <div class="bf-message-text">
                        <div class="bf-loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    ${this.config.showTimestamp?`<div class="bf-message-time">${this.getTimeString()}</div>`:""}
                </div>
            `,e.appendChild(s),this.scrollToBottom(),t}updatePlaceholderMessage(e,t,s){const a=document.getElementById(e);if(!a)return;const n=a.querySelector(".bf-message-text");s?(n.innerHTML=this.formatMarkdown(t)+'<span class="bf-cursor"></span>',a.classList.add("bf-streaming"),this.smartScroll()):(n.innerHTML=this.formatMarkdown(t),a.classList.remove("bf-streaming"),this.scrollToBottom())}smartScroll(){const e=document.getElementById("bf-messages");e&&e.scrollHeight-e.scrollTop-e.clientHeight<100&&(this.scrollAnimationFrame&&cancelAnimationFrame(this.scrollAnimationFrame),this.scrollAnimationFrame=requestAnimationFrame((()=>{e.scrollTop=e.scrollHeight,this.scrollAnimationFrame=null})))}formatMarkdown(e){if(!this.config.enableMarkdown)return this.escapeHtml(e).replace(/\n/g,"<br>");let s=this.escapeHtml(e);const a=[],n=[];return s=s.replace(/```([\s\S]*?)```/g,((e,s)=>{const n=a.length;return a.push(s),t.CODE_BLOCK_PLACEHOLDER+n+"}}"})),s=s.replace(/`([^`]+)`/g,((e,s)=>{const a=n.length;return n.push(s),t.INLINE_CODE_PLACEHOLDER+a+"}}"})),s=s.replace(/^### (.+)$/gm,"<h3>$1</h3>"),s=s.replace(/^## (.+)$/gm,"<h2>$1</h2>"),s=s.replace(/^# (.+)$/gm,"<h1>$1</h1>"),s=s.replace(/\*\*(.+?)\*\*/g,t.BOLD_PLACEHOLDER_START+"$1"+t.BOLD_PLACEHOLDER_END),s=s.replace(/__(.+?)__/g,t.BOLD_PLACEHOLDER_START+"$1"+t.BOLD_PLACEHOLDER_END),s=s.replace(/\*(.+?)\*/g,"<em>$1</em>"),s=s.replace(/_(.+?)_/g,"<em>$1</em>"),s=s.replace(new RegExp(t.BOLD_PLACEHOLDER_START,"g"),"<strong>"),s=s.replace(new RegExp(t.BOLD_PLACEHOLDER_END,"g"),"</strong>"),s=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,((e,s,a)=>{try{if(!t.ALLOWED_URL_SCHEMES.includes(new URL(a,window.location.href).protocol))return e;return`<a href="${this.escapeHtml(a)}" target="_blank" rel="noopener noreferrer">${s}</a>`}catch{return e}})),s=s.replace(/^\d+\.\s+(.+)$/gm,'<li data-list="ol">$1</li>'),s=s.replace(/^[\-\*]\s+(.+)$/gm,'<li data-list="ul">$1</li>'),s=s.replace(/(<li[^>]*>.+?<\/li>(?:\n<li[^>]*>.+?<\/li>)*)/g,(e=>{const t=e.includes('data-list="ol"')?"ol":"ul";return`<${t}>${e.replace(/ data-list="[^"]+"/g,"")}</${t}>`})),s=s.replace(/\n\n/g,"</p><p>"),s=s.replace(/\n/g,"<br>"),s="<p>"+s+"</p>",s=s.replace(/<p><\/p>/g,""),s=s.replace(/<p>(<[uo]l>)/g,"$1"),s=s.replace(/(<\/[uo]l>)<\/p>/g,"$1"),s=s.replace(/<p>(<h[123]>)/g,"$1"),s=s.replace(/(<\/h[123]>)<\/p>/g,"$1"),s=s.replace(new RegExp(t.INLINE_CODE_PLACEHOLDER+"(\\d+)}","g"),((e,t)=>`<code>${n[parseInt(t)]}</code>`)),s=s.replace(new RegExp(t.CODE_BLOCK_PLACEHOLDER+"(\\d+)}}","g"),((e,t)=>`<pre><code>${a[parseInt(t)]}</code></pre>`)),s}scrollToBottom(){const e=document.getElementById("bf-messages");e&&(e.scrollTop=e.scrollHeight)}getTimeString(){return(new Date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){this.abortController&&this.abortController.abort(),this.streamUpdateTimer&&clearTimeout(this.streamUpdateTimer),this.scrollAnimationFrame&&cancelAnimationFrame(this.scrollAnimationFrame),this.removeEventListeners();const e=document.getElementById("beautiful-flowise-container");e&&e.remove(),this.log("Widget destroyed")}}window.BeautifulFlowiseChat={init:function(e){if(!function(e){return e&&"object"==typeof e&&(e.chatflowid&&"string"==typeof e.chatflowid||(console.error("BeautifulFlowiseChat: chatflowid is required"),0))&&(e.apiHost&&"string"==typeof e.apiHost||(console.error("BeautifulFlowiseChat: apiHost is required"),0))}(e))return null;return new s({...e,mode:"popup"})},initFull:function(e){if(!function(e){return e&&"object"==typeof e&&(e.chatflowid&&"string"==typeof e.chatflowid||(console.error("BeautifulFlowiseChat: chatflowid is required"),0))&&(e.apiHost&&"string"==typeof e.apiHost||(console.error("BeautifulFlowiseChat: apiHost is required"),0))}(e))return null;return new s({...e,mode:"fullscreen"})}}}();